networks:
  web:
    external: false
  internal:
    external: false

volumes:
  pgdata:
  traefik_letsencrypt:
  backups:
  previews:
  meili:

services:
  traefik:
    image: traefik:v3.1
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:${TRAEFIK_HTTP_PORT:-80}"
      - "--entrypoints.websecure.address=:${TRAEFIK_HTTPS_PORT:-443}"
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - web
      - internal
    restart: unless-stopped

  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-kitsu}
      POSTGRES_USER: ${POSTGRES_USER:-kitsu}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kitsu_pass}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - internal

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - internal

  meilisearch:
    image: getmeili/meilisearch:v1.11
    restart: unless-stopped
    environment:
      MEILI_NO_ANALYTICS: "true"
    volumes:
      - meili:/meili_data
    networks:
      - internal

  zou-api:
    image: ghcr.io/ahmed-hindy/kitsu-zou:latest
    env_file:
      - .env
    ports:
      - "5001:8000"   # host:container
    environment:
      # ---- DB config (for Zou) ----
      DB_TYPE: postgres
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE: ${POSTGRES_DB}
      # ---- Redis / KV store ----
      KV_TYPE: redis
      KV_HOST: redis
      KV_PORT: 6379
      # ---- Meilisearch indexer ----
      INDEXER_TYPE: meilisearch
      INDEXER_HOST: meilisearch
      INDEXER_PORT: 7700
      # ---- Security / app settings ----
      SECRET_KEY: ${ZOU_SECRET_KEY}
      LOG_LEVEL: ${ZOU_LOG_LEVEL}
      # optionally:
      # CORS_ALLOWED_ORIGINS: http://localhost:8080
      # ALLOWED_HOSTS: ${KITSU_DOMAIN}

    depends_on:
      - db
      - redis
      - meilisearch
    networks:
      - internal
    restart: unless-stopped

  zou-events:
    image: ghcr.io/ahmed-hindy/kitsu-zou:latest
    env_file:
      - .env
    environment:
      DB_TYPE: postgres
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE: ${POSTGRES_DB}

      KV_TYPE: redis
      KV_HOST: redis
      KV_PORT: 6379

      INDEXER_TYPE: meilisearch
      INDEXER_HOST: meilisearch
      INDEXER_PORT: 7700

      SECRET_KEY: ${ZOU_SECRET_KEY}
      LOG_LEVEL: ${ZOU_LOG_LEVEL}

    # run ONLY the events server here
    command: >
      gunicorn
      --workers=1
      --worker-class=geventwebsocket.gunicorn.workers.GeventWebSocketWorker
      -b 0.0.0.0:5001
      zou.event_stream:app

    # optional, for debugging from host:
    # ports:
    #   - "5002:5001"

    depends_on:
      - db
      - redis
    networks:
      - internal
    restart: unless-stopped
  
  zou-init-db:
    image: ghcr.io/ahmed-hindy/kitsu-zou:latest
    env_file:
      - .env
    environment:
      # ---- DB config (for Zou) ----
      DB_TYPE: postgres
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_DATABASE: ${POSTGRES_DB}

      # ---- Redis / KV store ----
      KV_TYPE: redis
      KV_HOST: redis
      KV_PORT: 6379

      # ---- Meilisearch indexer ----
      INDEXER_TYPE: meilisearch
      INDEXER_HOST: meilisearch
      INDEXER_PORT: 7700

      # ---- Security / app settings ----
      SECRET_KEY: ${ZOU_SECRET_KEY}
      LOG_LEVEL: ${ZOU_LOG_LEVEL}
    depends_on:
      - db
      - redis
      - meilisearch
      - zou-api
    networks:
      - internal
    entrypoint: ["sh", "-c"]
    command: >
      "
      echo '[zou-init-db] Running init-db (safe if already initialized)...';
      zou init-db || echo '[zou-init-db] DB already initialized or init-db failed non-critically.';
      echo '[zou-init-db] Creating admin (or skipping if it already exists)...';
      zou create-admin ${ZOU_ADMIN_EMAIL} --password ${ZOU_ADMIN_PASSWORD} || echo '[zou-init-db] create-admin failed, possibly because the user already exists. Ignoring.';
      echo '[zou-init-db] Done.';
      "
    restart: "no"

  
  
  kitsu-web:
    image: ghcr.io/ahmed-hindy/kitsu-web:latest
    environment:
      VITE_API_URL: /api
    depends_on:
      - zou-api
    ports:
      - "8080:80"
    networks:
      - web
      - internal
    restart: unless-stopped

  db-backup:
    image: postgres:15
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGUSER: ${POSTGRES_USER}
      PGDATABASE: ${POSTGRES_DB}
      PGHOST: db
      BACKUP_CRON: ${BACKUP_CRON:-30 1 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-14}
    volumes:
      - backups:/backups
      - ./backups/backup.sh:/backup.sh:ro
    entrypoint: ["/bin/bash", "/backup.sh"]
    networks:
      - internal
    restart: unless-stopped
